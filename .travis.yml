language: python
python: 3.6
addons:
  ssh_known_hosts:
  - 81.31.168.207
stages:
- test
- name: deploy_test
  if: type = push AND (branch IN (travis_integration, production-test))
- name: deploy_production
  if: type = push AND (branch IN (master, travis_integration))
jobs:
  include:
  - stage: test
    services: postgresql
    env:
    - DJANGO=1.11
    before_install:
    - export DJANGO_SETTINGS_MODULE=aic_site.settings.development
    - export PYTHONPATH=$HOME/builds/SharifAIChallenge/aic_site
    - export PIP_USE_MIRRORS=true
    install:
    - pip install -r requirements/production.txt
    - pip install django==$DJANGO --quiet
    - pip install psycopg2 --quiet
    before_script:
    - psql -c "CREATE DATABASE mydb;" -U postgres
    script:
    - python manage.py makemigrations
    - python manage.py migrate
    - python manage.py test
  - stage: deploy_production
    addons:
      apt:
        packages:
        - sshpass
        - optipng
        - jpegoptim
        - rsync
    script:
    - mkdir build
    - rsync -r --exclude='.*' --exclude='build' --exclude='deploy' ./ build
    - cd build/config/nginx/sites-available
    - cp aichallenge.sharif.edu ../sites-enabled
    - cd ../../../..
    - cd deploy
    - cp deploy.sh Dockerfile ../build
    - cp ./docker-compose.yml ../build/docker-compose.yml
    - cd ..
    - cd build
    - sed -i 's/os.environ.setdefault("DJANGO_SETTINGS_MODULE", "aic_site.settings.development")/os.environ.setdefault("DJANGO_SETTINGS_MODULE",
      "aic_site.settings.production")/g' manage.py
    - cd ..
    - cd build/apps/
#    - find . -iname '*.png' -print0 | xargs -0 mogrify -resize 1000x1000
#    - find . -iname '*.jpg' -print0 | xargs -0 mogrify -resize 1000x1000
    - find . -iname '*.png' -print0 | xargs -0 optipng -o7 -preserve
    - find . -iname '*.jpg' -print0 | xargs -0 jpegoptim --max=90 --strip-all --preserve
      --totals
    - cd ../..
    - tar -czf deploy_package.tgz build
    - export SSHPASS=$DEPLOY_PASS
    - sshpass -e rsync --progress -avzhe 'ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
      deploy_package.tgz $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH
    - rm -r build deploy_package.tgz
    - sshpass -e rsync --progress -avzhe 'ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
      deploy/deploy.sh $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH
    - sshpass -e ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $DEPLOY_USER@$DEPLOY_HOST
      chmod +x $DEPLOY_PATH/deploy.sh
    - sshpass -e ssh -t -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
      $DEPLOY_USER@$DEPLOY_HOST sudo $DEPLOY_PATH/deploy.sh
  - stage: deploy_test
    addons:
      apt:
        packages:
        - sshpass
        - optipng
        - jpegoptim
        - rsync
    script:
    - mkdir build_test
    - rsync -r --exclude='.*' --exclude='build_test' --exclude='deploy' ./ build_test
    - cd build_test/config/nginx/sites-available
    - cp aichallenge.sharif.edu.test ../sites-enabled
    - cd ../../../..
    - cd deploy
    - cp deploy_test.sh Dockerfile ../build_test
    - cp ./docker-compose_test.yml ../build_test/docker-compose.yml
    - cd ..
    - cd build_test
    - sed -i 's/os.environ.setdefault("DJANGO_SETTINGS_MODULE", "aic_site.settings.development")/os.environ.setdefault("DJANGO_SETTINGS_MODULE",
      "aic_site.settings.production_test")/g' manage.py
    - cd ..
    - cd build_test/apps/
#    - find . -iname '*.png' -print0 | xargs -0 mogrify -resize 1000x1000
#    - find . -iname '*.jpg' -print0 | xargs -0 mogrify -resize 1000x1000
    - find . -iname '*.png' -print0 | xargs -0 optipng -o7 -preserve
    - find . -iname '*.jpg' -print0 | xargs -0 jpegoptim --max=90 --strip-all --preserve
      --totals
    - cd ../..
    - tar -czf deploy_test_package.tgz build_test
    - export SSHPASS=$DEPLOY_PASS
    - sshpass -e rsync --progress -avzhe 'ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
      deploy_test_package.tgz $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH
    - rm -r build_test deploy_test_package.tgz
    - sshpass -e rsync --progress -avzhe 'ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
      deploy/deploy_test.sh $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH
    - sshpass -e ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $DEPLOY_USER@$DEPLOY_HOST
      chmod +x $DEPLOY_PATH/deploy_test.sh
    - sshpass -e ssh -t -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
      $DEPLOY_USER@$DEPLOY_HOST sudo $DEPLOY_PATH/deploy_test.sh
env:
  global:
  - secure: L1dK4fyG0F2ANB5yhFS1LLO2ihgsjRKmd9DfZab/832cSBLoO4lbmN03tfCbDrwURF+spdAUqnf8uqSo+dqKe+Ve9pZKT8W/OqhenQ95Ri8yDfTas1GBmCBcqpMR5RSxZ9E7joVRbzgw77UCzleU3Q6qn7PJarD5tMQZZQt85k85gnaFScD5QHJU/sTbGgiXWVIoJkwvoFU7zTbb0+7yQ+a58hGHDxrDMNXynAFbkXJUnGwS7roKmCSe5yGA5b096YsujA8TocmppUlzzueRn2Zyi+dj60kMuOdavR58TI23I83/px1xZUrUoSlkXG4VYNorM1H6X+1padWVSbaaA8o5JgbqJrR9EF9F+YWY3ic+exOg+7j1nzxug6mG479WG9o7Lw2epB8F3ikd0/fBQDi7Gr3p3IGjsV6cTCZIGA6O1Y+ms6lVD5kJQNQXo0hojztDN0f26R9tNAg1cROZcPGe05yorRPMjXY6OLarjBj5rYFixDcAmcQnL16jcihFxExcJaB6Z4Gi6OH1DI4ElKQQCDD5OZYsU4YUBZhY8X+WEK+wSsL8KvXETmdHmgbcp6tI5u/edzwlzbm3msKGRRImQCqvQ06GgyAJbtb7IitmGE8W1XbD6BZjgwByyGqRfff4Tux8qhWBX6iQPdCFi6mDba332YTq23MxrtetBfo=
  - secure: M+RBkURPN3zt8yrwQto0V449m/PjRamjMkxTI241aICTHNnaxGzF2Hki7U4U8Ey9XXYFCUzCBNEElJAACM/GkMslX9qQzZL8b8eYSvQkJZybqmkJz80NGpIj8cpT6xK9xfbSKuPgI61uS5ccwU6kGVoBSPDEdpS/fqrzzIZx5YBZ5yMEyWMkYJDL5RrwR1+z7AW5jZB21npYa4XqM7/RgyVOv5h4tZaKIyyf9cb04/VyZv5imT0UEIV/Xm/UCRnY3XG/XANzCdCx04iVov4l3G7hckvGCk7/8lZK2a3npt8IIgY8vw3s2PnCwQSW5f65Yovg5iUX4ZAWmuyvqEhvYCUdkYqyukymIZEf5ZM7J9jEJhwg8+jT/C3Wnk7NQlM/lBoOaNKS9xqLlYPCgOSyBvR1Nqeza3USlmqrbnkQowQH2w4Up+OWFYQUZvyE20jZSqa4EvPsI7AAsC52Lbp9P1pG2dstWTnVGya7TXOKeHcRy3mR/D8PV1HSKgbz7Y8TJ/1QwirOn6aYCi/KhF71UP1LZhlI8S3tNIm/A6icsKfqYxK4M3OMGzd7GcvpwsCrZkDAguVGMlMDQjzA0hOzOC0svDSXBwKLur39Ku6WwuPdJEIEBlTayYndwDwo00XCm6YdK+UkTyQZgDcf3dB73tRhmnjE3k33h66qH6yS5nI=
  - secure: UFklBqbldGTQqX7VW6v8wTNPwIyi7dzg5fcAhHhwcp55dot/gMxd9d1KM7bpe3l8TOZJMrvSCNcdtrXgyo+1BqtBXtrl2EHjSYmp5QW3KhXmYVOwrPb2hA7vUb5VQ5eKvRQ2TbCTCiHmCLmfz03EBp9FaxVObUyATX5GLjsbmaGW4GZDuQ/BSZMQFs/ZsvCtmr4HTxOsd/LKlmzZjelrevyrBfrm9NAyNuuX0cxUd6ooPB7ySVKDHrRBHJyDTq7fzVqvCeDlcza2O4RM4jiPs3hMxV/aR6lJX+aB8xmpEs/IktR8qugQPsjo/OIK/dWoryprkXGLS7J7jYRx2hRhIOeWSR+oV++xcCCACEm8x9fNqjvFL94ir4g/WKssvkB6jOaE1+i/CG/mLN7GYgAuLT+4iOcuKiYLz7X0xcqyw5Kl4pPAeYEUtrBVW/U7hazgL+WGMvXkP26dIyjJXin7ceFkJlqnAUlW2Iz83lHkmdb6XukrDo+EkckRI3FAQjHzNz4q2Ig9DsiRnNJ+isi+FVNUQMVbUX/s6GCRjuZltHuae1LHcrXQZNhXngLTxZsokL/Q6Oc29JvH+XEs1NZlWGRmghwa7MSrS5Z+rUcZ6tMuYelsQe308KEBbEKVqBl9R18AkWzqJXEO01zycBjDmmMsrVcqcVi031hcsHSaheQ=
  - secure: DmSnIpaC+it3tRb7Wv8SV8oaqsA4vIKMFIAjPShdBkVBmP4jnwMf+64ZJoBM0x42JP4m68TabQYeSi87FGcL94DDuyYmYb1x7c+NaKwB9zFeT172HGKA4imC4W2BgdOEZ3ljGYw7TGBxmbJ2XVUS3T061f8BCCAeJL93snV4xLBtk8Hd4Iww+Qb+cGvY373hDOA1Bwo1IkXEWo5UBHuEHsHFc3mxm81MoIIei3tLMAwNTnc9s9yK1TAroHL6FSb5OPOySxNX00DLxz+7AeZ+JEjwENXdeTxUxaHQ5iXnrPeNxDmTNPmqMAEviGUJBLd0eNwe6IKrs+UV2Rs/VkCvVV1PXlyIF9abODc+PutZXQBDH4/K553uNsG+n593ZHyD71GrmlilSRqIBbh2Hi8bN/wbSZcG0Lh+i589XsGK+4PpLUQnmRLl8Z3ybT6XIECUzpP/f2xTXZhjJGO7pFQX5aNCTVtpWZXwfUXTpxrpNvpoKlX+7kzlpubkNgXQFlXNMDBOD4JE1dwcaLFrPrOuI2GaOA2BTlkwS05/wyBtWhmgfQhOv/40cPdfg7XoL8Wp3pBsiWNTIpzBIE3NrU2CmP5Tr4MSZnVnK43/GAehKUsbB7oKk11v/j3ArGfbRe19npnmD+QQ9gPCTN6zYXQualf/M5Xd6DitTpPgZU4c04w=
