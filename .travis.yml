group: deprecated-2017Q4
language: python
python: 3.6
stages:
- test
- name: deploy_test
  if: type = push AND (branch IN (travis_integration, production-test))
- name: deploy_production
  if: type = push AND (branch IN (master, travis_integration))
jobs:
  include:
  - stage: test
    services: postgresql
    env:
    - DJANGO=1.11
    before_install:
    - export DJANGO_SETTINGS_MODULE=aic_site.settings.development
    - export PYTHONPATH=$HOME/builds/SharifAIChallenge/aic_site
    - export PIP_USE_MIRRORS=true
    install:
    - pip install -r requirements/production.txt
    - pip install django==$DJANGO --quiet
    - pip install psycopg2 --quiet
    before_script:
    - psql -c "CREATE DATABASE mydb;" -U postgres
    script:
    - python manage.py makemigrations
    - python manage.py migrate
    - python manage.py test
  - stage: deploy_production
    addons:
      apt:
        packages:
        - sshpass
        - optipng
        - jpegoptim
        - rsync
    script:
    - mkdir build
    - rsync -r --exclude='.*' --exclude='build' --exclude='deploy' ./ build
    - cd build/config/nginx/sites-available
    - cp aichallenge.sharif.edu ../sites-enabled
    - cd ../../../..
    - cd deploy
    - cp deploy.sh Dockerfile ../build
    - cp ./docker-compose.yml ../build/docker-compose.yml
    - cd ..
    - cd build
    - sed -i 's/os.environ.setdefault("DJANGO_SETTINGS_MODULE", "aic_site.settings.development")/os.environ.setdefault("DJANGO_SETTINGS_MODULE",
      "aic_site.settings.production")/g' manage.py
    - cd ..
    - cd build/apps/
    - find . -iname '*.png' -print0 | xargs -0 optipng -o7 -preserve
    - find . -iname '*.jpg' -print0 | xargs -0 jpegoptim --max=90 --strip-all --preserve
      --totals
    - cd ../..
    - tar -czf deploy_package.tgz build
    - export SSHPASS=$DEPLOY_PASS
    - sshpass -e rsync --progress -avzhe 'ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
      deploy_package.tgz $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH
    - rm -r build deploy_package.tgz
    - sshpass -e rsync --progress -avzhe 'ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
      deploy/deploy.sh $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH
    - sshpass -e ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $DEPLOY_USER@$DEPLOY_HOST
      chmod +x $DEPLOY_PATH/deploy.sh
    - sshpass -e ssh -t -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
      $DEPLOY_USER@$DEPLOY_HOST sudo $DEPLOY_PATH/deploy.sh
  - stage: deploy_test
    addons:
      apt:
        packages:
        - sshpass
        - optipng
        - jpegoptim
        - rsync
    script:
    - mkdir build_test
    - rsync -r --exclude='.*' --exclude='build_test' --exclude='deploy' ./ build_test
    - cd build_test/config/nginx/sites-available
    - cp aichallenge.sharif.edu.test ../sites-enabled
    - cd ../../../..
    - cd deploy
    - cp deploy_test.sh Dockerfile ../build_test
    - cp ./docker-compose_test.yml ../build_test/docker-compose.yml
    - cd ..
    - cd build_test
    - sed -i 's/os.environ.setdefault("DJANGO_SETTINGS_MODULE", "aic_site.settings.development")/os.environ.setdefault("DJANGO_SETTINGS_MODULE",
      "aic_site.settings.production_test")/g' manage.py
    - cd ..
    - cd build_test/apps/
    - find . -iname '*.png' -print0 | xargs -0 optipng -o7 -preserve
    - find . -iname '*.jpg' -print0 | xargs -0 jpegoptim --max=90 --strip-all --preserve
      --totals
    - cd ../..
    - tar -czf deploy_test_package.tgz build_test
    - export SSHPASS=$DEPLOY_PASS
    - sshpass -e rsync --progress -avzhe 'ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
      deploy_test_package.tgz $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH
    - rm -r build_test deploy_test_package.tgz
    - sshpass -e rsync --progress -avzhe 'ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
      deploy/deploy_test.sh $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH
    - sshpass -e ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $DEPLOY_USER@$DEPLOY_HOST
      chmod +x $DEPLOY_PATH/deploy_test.sh
    - sshpass -e ssh -t -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
      $DEPLOY_USER@$DEPLOY_HOST sudo $DEPLOY_PATH/deploy_test.sh
env:
  global:
  - secure: m45dMAMhb9aYquY2fdVK5OfgB77QqaF4KaFFlcpqbPMUlv3ll7YX9ri6ovMLZtrzejsVW8kt7wPPm7swk86XYK05/gIcTJHWA++8akWhYa0u26PLEqwqJRNqt5GiQYOBeCQX33qiOIZK1C3OWNuhpY7xRR2auR6F58KeAwflb2J4jeidiAHu/2xQkiDqsTj4OziXAA2XnZmkWYew4mp3TM0hptSjFXw2NTgCdeDq8v1Jr4zLYt0dt52CFAWiXEA5KagxV++6g12fb5g6wwIgb9eRokaTv4bhQYdWbYTJ/NOmqCMgykOAs/3ECxjKwsta/hh7CXKZ47W+ee70pvOg8Cl5cVFZgp+dH4O1c06IK/4qWFlG1vMtaU5j3kITMZCSZbm/GyJEKD/XmybeKMXKLYsdmqgvmPTNh/UyyaIzP9GYDJy546A+W+BpA7x9jXzLlRZ7+C4UsSYWVQli//2bIqVJnsxt5yRvu8+tKUI+RsQm/F/K91dD4tVoEaka372sojF+uHLCyOyE2GV6vj+DNhT5lECpZExfKEYIEHkPwqIoJ6e89WQHmhMngU8L/S2JapLx5ONYEvZpIpcJy1b/QRXGvEJHFraeo31lcIT2/eZ+dE6bKYYROJ9NdOFLv1iNwbE7Hd1Uio2FgeHiW/CXxFU4vXqgevTrt72TU3uAeBg=
  - secure: IdnAjE4Nhcky4HFDA12WnQIW98mjLd4lX5Q3lcdDyxx+84l3026ThQAVPT5b5Z9y7lqqKRSOAe1+G91PuKxnAq4KIwh7wuJa4YTbrVhR9MUsylCOG2J/MzHceWOLOtZ+E7v1EfGx1iaNFdOdUo3eiGfkjEMjL1GdeYDI3FcvpWZXBmCPkAAF3ATpKQb2w01TXwSIhDmOYGCavVYBfZj3SaEwcggG/pZkOxyRkBJogn5rNUuqMq/SwdAxDm/TwwCLp4N+T8mlPprSXpwgruaHBVyvmKumS+sjESbJ/YdGJ37RmePQTHoiAZCyMxBywMbmwHb3v7FoWCuVPxdahtn9srOR4TQ8z2K/0Us5r8mH7LsxjDLneqxwL0bqpsxsYaglH1/Yj58WtwEjZfucxQlpi2CKMfJkJ/txaW5ge7h6qdc5SEQXoepyG0S2GCHPGhOVBFBLIf/RgaSHZ57+aUD7tN7rYiv6J98IigmZuREifns5fKJCjPj+bUww0TPKA3BvO8Cep3KnSkxBOgFx5dzhUNyaUFr+UAnoF4qUlVYm5/B8/UIo+PTXhupG9wdiTvUulF54LpfshDSzM8dsTFUNOXTIQBU9v0r9uoF5i83PBZA727q8e1ZI1MzckUMnE4k/v0QpPMHBclCg2q9ACpLD4nU0JqXtZfqOJOGLrcpTqcY=
  - secure: Iuigd8VjyZHGXTF0pvlh0rM6eJvB6d1WFVPhb6iuQnBfnM2Ob1Yfh7P48IrtM48EOOHEykhA+GbijElWOzfr3fx4IBUlTQ5S+SmUjZFiDycUY9V4wYgDdGjUaBTT72hsWRLeBEuL0pohNuCcroKjqrBLCd6Usxscn8gL4ms8WHMZIYsCZFlzN7tdsW7dTwKfcqFWC+l58NEFvTa0gcbEz2fdfKHzK3SCglfUrz7yb/KcU9thIP+Oc+GCdqTSLUfc66fpd9KCDcvHoXrr7A1gEleCJ/APuTzmDSlUHuaf0xrG0b9b7S1az9ITHGU3MM35kHosHNWADEezWEhmM04HCI4vWlAA4FyoKccJtOxaFjBQtBCAkGyVRwZXxAvozjWBwVVoXf8d/27+dwnVW4zidkJhccYVEoZ0nn1tXFI+y9bjO9naXyYU9+TNdD6v5/ri75LgiFR6U91ocGGCXWF8Et3JEE4lLHeEjRlumKAD8PoF0XzcBKMd7QIyqjsU+4SNss1Qb5nozhZwOComadoBeX0puv98fjtqaeLjXxk80xJ7YkgDUymChhX0UJoREitBb5VmzBbtT1ihsUaGIl+8B7J5qfEmgzCfFeCfUFUBg9wz6FmEAgRxjwSMJnL0EoYSv4yMXj/02lsJ/mpLPqd+SlwpSPDUdyYQuPnwRqDBTI8=
  - secure: q/7+ISv2nHrP+8MWa7NaAyiBhg21skWFAt5R5an0DhrjbFDA338VFL0SvPujSHD7WSfQ4JnkkVnilyzHQ2lzVXFy8XH92YiHsX9FlkaJ/UVnsnsTUDI2TsQ0dDjd4psYluiSSu/oWfw6ygKaAJ+jJXiXYRDnSMlQylsRthGHnUVJEN6jzNPg4rPRyMmbER5e8Nf772169xfwfXRKwtZhj9KW+CLRRqtvlGL9QxKLLIXgFHcYVagojaes2xP5gD/UUeEh6ic3eNfPHZibw0Ed8GBEaBcAChTBOvSBOIWRz92ZBHL6LM34NdSA7ylhcSQ7ux4Txlkb1WOT6vkx0FIqxDDASpZH3vHIoUy+9PAUhE2B0s83f/eO+3cCzIcdEJlQvJvgukztHjiFOEru899pc2YGoDIj/ungwinfnxcRwlXoA2Yg0UKPD66dTZyyDt05lvbeenjPJJdZat7KVA/kQxV96Nm3qdtZm8cJyCw1mpcA0xQpOqafgljhIBULhhvg+oJQ3+mr1quNdJDEQqTFwncQxuPleO5Ohz6dodoPV7aegUwxRec4N5LeCEIO8Nm+kUvaXokW/kiWP0q2abKHJ+VBP7H+xfm3FrGTUUTgt7t7Tf+NdhInDkR8PevLTJ7QwFkpTiuE1oebniW5PdaPYVOm0Okrbfk9+uJmV+45khM=
